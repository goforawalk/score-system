<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯„åˆ†æäº¤è°ƒè¯•æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { background: #007bff; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .config { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .config input, .config select { margin: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .log { background: #1e1e1e; color: #f8f8f2; padding: 15px; border-radius: 6px; font-family: monospace; max-height: 400px; overflow-y: auto; }
        .log-entry { margin-bottom: 5px; }
        .log-info { color: #87ceeb; }
        .log-success { color: #90ee90; }
        .log-error { color: #ff6b6b; }
        .data-preview { background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 10px 0; }
        .data-preview pre { margin: 0; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” è¯„åˆ†æäº¤è°ƒè¯•æµ‹è¯•</h1>
            <p>ä¸“é—¨ç”¨äºè°ƒè¯•è¯„åˆ†æäº¤APIçš„HTTP 500é”™è¯¯</p>
        </div>
        
        <div class="config">
            <h3>æµ‹è¯•é…ç½®</h3>
            <label>åç«¯APIåœ°å€: <input type="text" id="baseUrl" value="http://localhost:8080"></label><br>
            <label>APIå‰ç¼€: <input type="text" id="apiPrefix" value="/api"></label><br>
            <label>é¡¹ç›®ID: <input type="number" id="projectId" value="734"></label><br>
            <label>ä»»åŠ¡ID: <input type="number" id="taskId" value="539"></label><br>
            <label>ç”¨æˆ·å: <input type="text" id="username" value="admin"></label>
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button id="testScoreSubmission" class="btn btn-primary">ğŸš€ æµ‹è¯•è¯„åˆ†æäº¤</button>
            <button id="clearLog" class="btn btn-success">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="data-preview">
            <h4>è¯„åˆ†æ•°æ®ç»“æ„é¢„è§ˆï¼š</h4>
            <pre id="scoreDataPreview"></pre>
        </div>
        
        <div class="log" id="logContainer">
            <div class="log-entry log-info">ç­‰å¾…å¼€å§‹æµ‹è¯•...</div>
        </div>
    </div>

    <script>
        let testData = {
            userInfo: null,
            taskId: null,
            projectId: null
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `${prefix} [${timestamp}] ${message}`;
            document.getElementById('logContainer').appendChild(logEntry);
            document.getElementById('logContainer').scrollTop = document.getElementById('logContainer').scrollHeight;
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '<div class="log-entry log-info">æ—¥å¿—å·²æ¸…ç©º...</div>';
        }

        function buildApiUrl(path) {
            const baseUrl = document.getElementById('baseUrl').value;
            const apiPrefix = document.getElementById('apiPrefix').value;
            return `${baseUrl}${apiPrefix}${path}`;
        }

        function updateScoreDataPreview() {
            const projectId = parseInt(document.getElementById('projectId').value);
            const taskId = parseInt(document.getElementById('taskId').value);
            const username = document.getElementById('username').value;
            
            const scoreData = {
                projectId: projectId,
                taskId: taskId,
                username: username,
                scores: {
                    1: 85
                },
                totalScore: 85.0,
                comments: 'è°ƒè¯•æµ‹è¯•è¯„åˆ†',
                isDraft: false
            };
            
            document.getElementById('scoreDataPreview').textContent = JSON.stringify(scoreData, null, 2);
        }

        async function httpRequest(url, options = {}) {
            const defaultOptions = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                timeout: 10000
            };

            const finalOptions = { ...defaultOptions, ...options };
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), finalOptions.timeout);
                
                const response = await fetch(url, {
                    ...finalOptions,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${response.statusText}\nå“åº”å†…å®¹: ${errorText}`);
                }
                
                return await response.json();
            } catch (error) {
                throw new Error(`è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        async function testScoreSubmission() {
            clearLog();
            log('å¼€å§‹è¯„åˆ†æäº¤è°ƒè¯•æµ‹è¯•...', 'info');
            
            const projectId = parseInt(document.getElementById('projectId').value);
            const taskId = parseInt(document.getElementById('taskId').value);
            const username = document.getElementById('username').value;
            
            let scoreData = null; // å£°æ˜åœ¨å‡½æ•°é¡¶éƒ¨
            
            try {
                // é¦–å…ˆå°è¯•è·å–é¡¹ç›®è¯¦æƒ…ï¼Œçœ‹æ˜¯å¦åŒ…å«è¯„åˆ†é¡¹ä¿¡æ¯
                log('è·å–é¡¹ç›®è¯¦æƒ…...', 'info');
                try {
                    const projectResponse = await httpRequest(buildApiUrl(`/projects/${projectId}`));
                    
                    if (projectResponse.success && projectResponse.data) {
                        const project = projectResponse.data;
                        log(`é¡¹ç›®è¯¦æƒ…: ${JSON.stringify(project, null, 2)}`, 'info');
                        
                        // æ£€æŸ¥é¡¹ç›®æ˜¯å¦åŒ…å«è¯„åˆ†é¡¹ä¿¡æ¯
                        let scoreItems = [];
                        if (project.scoreItems && Array.isArray(project.scoreItems)) {
                            scoreItems = project.scoreItems;
                        } else if (project.scoreGroups) {
                            // å¦‚æœæœ‰scoreGroupsï¼Œå°è¯•ä»ä¸­æå–è¯„åˆ†é¡¹
                            Object.values(project.scoreGroups).forEach(group => {
                                if (Array.isArray(group)) {
                                    scoreItems = scoreItems.concat(group);
                                }
                            });
                        }
                        
                        if (scoreItems.length > 0) {
                            log(`ä½¿ç”¨é¡¹ç›®è¯„åˆ†é¡¹: ${JSON.stringify(scoreItems.map(item => ({id: item.id, name: item.name})))}`, 'info');
                            
                            // æ„å»ºå®Œæ•´çš„è¯„åˆ†æ•°æ®ï¼ŒåŒ…å«æ¯ä¸ªè¯„åˆ†é¡¹çš„å…·ä½“åˆ†æ•°
                            const scores = {};
                            let totalScore = 0;
                            let scoreCount = 0;
                            
                            // ä½¿ç”¨å®é™…çš„è¯„åˆ†é¡¹ID
                            scoreItems.forEach((item, index) => {
                                const score = 85; // æ¯ä¸ªè¯„åˆ†é¡¹ç»™85åˆ†
                                scores[item.id] = score;
                                totalScore += score;
                                scoreCount++;
                            });
                            
                            // è®¡ç®—å¹³å‡åˆ†
                            const averageScore = scoreCount > 0 ? totalScore / scoreCount : 0;
                            
                            scoreData = {
                                projectId: projectId,
                                taskId: taskId,
                                username: username,
                                scores: scores, // åŒ…å«æ¯ä¸ªè¯„åˆ†é¡¹çš„å…·ä½“åˆ†æ•°
                                totalScore: averageScore, // è®¡ç®—å‡ºçš„å¹³å‡åˆ†
                                comments: 'è°ƒè¯•æµ‹è¯•è¯„åˆ† - åŒ…å«å„è¯„åˆ†é¡¹è¯¦ç»†åˆ†æ•°',
                                isDraft: false
                            };
                        }
                    }
                } catch (projectError) {
                    log(`è·å–é¡¹ç›®è¯¦æƒ…å¤±è´¥: ${projectError.message}ï¼Œä½¿ç”¨é»˜è®¤è¯„åˆ†é¡¹`, 'info');
                }
                
                // å¦‚æœæ²¡æœ‰è·å–åˆ°é¡¹ç›®è¯¦æƒ…æˆ–è¯„åˆ†é¡¹ï¼Œä½¿ç”¨é»˜è®¤å€¼
                if (!scoreData) {
                    log('ä½¿ç”¨é»˜è®¤è¯„åˆ†é¡¹ID', 'info');
                    const defaultScoreItems = [
                        { id: 1, name: 'æŠ€æœ¯å®ç°' },
                        { id: 2, name: 'ç”¨æˆ·ä½“éªŒ' },
                        { id: 3, name: 'ä»£ç è´¨é‡' },
                        { id: 4, name: 'æ–‡æ¡£è´¨é‡' }
                    ];
                    
                    const scores = {};
                    defaultScoreItems.forEach((item, index) => {
                        scores[item.id] = 85; // ä½¿ç”¨é»˜è®¤è¯„åˆ†é¡¹IDä½œä¸ºé”®
                    });
                    
                    scoreData = {
                        projectId: projectId,
                        taskId: taskId,
                        username: username,
                        scores: scores,
                        totalScore: 85.0,
                        comments: 'è°ƒè¯•æµ‹è¯•è¯„åˆ†',
                        isDraft: false
                    };
                }
                
                log(`è¯„åˆ†æ•°æ®: ${JSON.stringify(scoreData, null, 2)}`, 'info');
                log(`API URL: ${buildApiUrl('/scores')}`, 'info');
                
                const response = await httpRequest(buildApiUrl('/scores'), {
                    method: 'POST',
                    body: JSON.stringify(scoreData)
                });
                
                log('âœ… è¯„åˆ†æäº¤æˆåŠŸï¼', 'success');
                log(`å“åº”æ•°æ®: ${JSON.stringify(response, null, 2)}`, 'success');
                
            } catch (error) {
                log(`âŒ è¯„åˆ†æäº¤å¤±è´¥: ${error.message}`, 'error');
                
                // å°è¯•ä¸åŒçš„æ•°æ®ç»“æ„
                log('å°è¯•ä¸åŒçš„æ•°æ®ç»“æ„...', 'info');
                
                // å°è¯•1: ç§»é™¤taskId
                try {
                    const scoreDataWithoutTaskId = { ...scoreData };
                    delete scoreDataWithoutTaskId.taskId;
                    log(`å°è¯•1 - ç§»é™¤taskId: ${JSON.stringify(scoreDataWithoutTaskId, null, 2)}`, 'info');
                    
                    const response1 = await httpRequest(buildApiUrl('/scores'), {
                        method: 'POST',
                        body: JSON.stringify(scoreDataWithoutTaskId)
                    });
                    
                    log('âœ… å°è¯•1æˆåŠŸï¼ˆç§»é™¤taskIdï¼‰', 'success');
                    log(`å“åº”: ${JSON.stringify(response1, null, 2)}`, 'success');
                    return;
                } catch (error1) {
                    log(`âŒ å°è¯•1å¤±è´¥: ${error1.message}`, 'error');
                }
                
                // å°è¯•2: ä¿®æ”¹scoresæ ¼å¼ä¸ºæ•°ç»„
                try {
                    const scoreDataWithArrayScores = { ...scoreData };
                    scoreDataWithArrayScores.scores = [
                        { itemId: 1, score: 85 },
                        { itemId: 2, score: 85 },
                        { itemId: 3, score: 85 },
                        { itemId: 4, score: 85 }
                    ];
                    log(`å°è¯•2 - æ•°ç»„æ ¼å¼scores: ${JSON.stringify(scoreDataWithArrayScores, null, 2)}`, 'info');
                    
                    const response2 = await httpRequest(buildApiUrl('/scores'), {
                        method: 'POST',
                        body: JSON.stringify(scoreDataWithArrayScores)
                    });
                    
                    log('âœ… å°è¯•2æˆåŠŸï¼ˆæ•°ç»„æ ¼å¼scoresï¼‰', 'success');
                    log(`å“åº”: ${JSON.stringify(response2, null, 2)}`, 'success');
                    return;
                } catch (error2) {
                    log(`âŒ å°è¯•2å¤±è´¥: ${error2.message}`, 'error');
                }
                
                // å°è¯•3: ç®€åŒ–æ•°æ®ç»“æ„
                try {
                    const simpleScoreData = {
                        projectId: projectId,
                        username: username,
                        totalScore: 85.0,
                        comments: 'ç®€åŒ–æµ‹è¯•è¯„åˆ†'
                    };
                    log(`å°è¯•3 - ç®€åŒ–æ•°æ®ç»“æ„: ${JSON.stringify(simpleScoreData, null, 2)}`, 'info');
                    
                    const response3 = await httpRequest(buildApiUrl('/scores'), {
                        method: 'POST',
                        body: JSON.stringify(simpleScoreData)
                    });
                    
                    log('âœ… å°è¯•3æˆåŠŸï¼ˆç®€åŒ–æ•°æ®ç»“æ„ï¼‰', 'success');
                    log(`å“åº”: ${JSON.stringify(response3, null, 2)}`, 'success');
                    return;
                } catch (error3) {
                    log(`âŒ å°è¯•3å¤±è´¥: ${error3.message}`, 'error');
                }
                
                log('æ‰€æœ‰å°è¯•éƒ½å¤±è´¥äº†ï¼Œè¯·æ£€æŸ¥åç«¯æ—¥å¿—è·å–æ›´å¤šä¿¡æ¯', 'error');
            }
        }

        document.getElementById('testScoreSubmission').addEventListener('click', testScoreSubmission);
        document.getElementById('clearLog').addEventListener('click', clearLog);

        // åˆå§‹åŒ–æ•°æ®é¢„è§ˆ
        document.addEventListener('DOMContentLoaded', function() {
            updateScoreDataPreview();
            
            // ç›‘å¬è¾“å…¥å˜åŒ–
            document.getElementById('projectId').addEventListener('input', updateScoreDataPreview);
            document.getElementById('taskId').addEventListener('input', updateScoreDataPreview);
            document.getElementById('username').addEventListener('input', updateScoreDataPreview);
            
            log('è¯„åˆ†æäº¤è°ƒè¯•æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            log('è¯·é…ç½®å‚æ•°å¹¶ç‚¹å‡»"æµ‹è¯•è¯„åˆ†æäº¤"æŒ‰é’®', 'info');
        });
    </script>
</body>
</html> 