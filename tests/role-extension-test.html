<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§’è‰²æ‰©å±•åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-title {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .user-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .role-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .role-admin {
            background-color: #dc3545;
            color: white;
        }
        .role-expert {
            background-color: #007bff;
            color: white;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>è§’è‰²æ‰©å±•åŠŸèƒ½æµ‹è¯•</h1>
        <p>éªŒè¯ç³»ç»Ÿè§’è‰²ä»3ä¸ªä¸“å®¶æ‰©å±•åˆ°8ä¸ªè§’è‰²ï¼ˆç®¡ç†å‘˜ã€è¯„å®¡ä¸“å®¶1-7ï¼‰çš„åŠŸèƒ½</p>

        <div class="test-section">
            <h2 class="test-title">1. ç”¨æˆ·æ•°æ®éªŒè¯</h2>
            <button onclick="testUserData()">æµ‹è¯•ç”¨æˆ·æ•°æ®</button>
            <div id="userDataResult"></div>
        </div>

        <div class="test-section">
            <h2 class="test-title">2. è§’è‰²æ˜ å°„éªŒè¯</h2>
            <button onclick="testRoleMapping()">æµ‹è¯•è§’è‰²æ˜ å°„</button>
            <div id="roleMappingResult"></div>
        </div>

        <div class="test-section">
            <h2 class="test-title">3. ç™»å½•è·³è½¬éªŒè¯</h2>
            <button onclick="testLoginRedirect()">æµ‹è¯•ç™»å½•è·³è½¬</button>
            <div id="loginRedirectResult"></div>
        </div>

        <div class="test-section">
            <h2 class="test-title">4. æƒé™éªŒè¯</h2>
            <button onclick="testPermissionCheck()">æµ‹è¯•æƒé™éªŒè¯</button>
            <div id="permissionResult"></div>
        </div>

        <div class="test-section">
            <h2 class="test-title">5. é¡¹ç›®ç®¡ç†è§’è‰²é…ç½®</h2>
            <button onclick="testProjectRoles()">æµ‹è¯•é¡¹ç›®è§’è‰²é…ç½®</button>
            <div id="projectRolesResult"></div>
        </div>

        <div class="test-section">
            <h2 class="test-title">6. ç»Ÿè®¡åŠŸèƒ½éªŒè¯</h2>
            <button onclick="testStatistics()">æµ‹è¯•ç»Ÿè®¡åŠŸèƒ½</button>
            <div id="statisticsResult"></div>
        </div>

        <div class="test-section">
            <h2 class="test-title">7. ç»¼åˆæµ‹è¯•</h2>
            <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <div id="allTestsResult"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../js/api/mock.js"></script>
    <script src="../js/utils/auth.js"></script>
    <script src="../js/admin/user-management.js"></script>

    <script>
        // æµ‹è¯•ç”¨æˆ·æ•°æ®
        function testUserData() {
            const result = document.getElementById('userDataResult');
            result.innerHTML = '';

            try {
                // éªŒè¯ç”¨æˆ·æ•°é‡
                const expectedCount = 8; // 1ä¸ªç®¡ç†å‘˜ + 7ä¸ªä¸“å®¶
                const actualCount = mockApi.users.length;
                
                if (actualCount === expectedCount) {
                    result.innerHTML += '<div class="test-result success">âœ… ç”¨æˆ·æ•°é‡æ­£ç¡®: ' + actualCount + ' ä¸ªç”¨æˆ·</div>';
                } else {
                    result.innerHTML += '<div class="test-result error">âŒ ç”¨æˆ·æ•°é‡é”™è¯¯: æœŸæœ› ' + expectedCount + 'ï¼Œå®é™… ' + actualCount + '</div>';
                }

                // éªŒè¯è§’è‰²åˆ†å¸ƒ
                const adminCount = mockApi.users.filter(u => u.role === 'admin').length;
                const expertCount = mockApi.users.filter(u => u.role.startsWith('expert')).length;
                
                result.innerHTML += '<div class="test-result info">ğŸ“Š è§’è‰²åˆ†å¸ƒ: ç®¡ç†å‘˜ ' + adminCount + ' ä¸ªï¼Œä¸“å®¶ ' + expertCount + ' ä¸ª</div>';

                // æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
                let userListHtml = '<div class="user-list">';
                mockApi.users.forEach(user => {
                    const roleClass = user.role === 'admin' ? 'role-admin' : 'role-expert';
                    userListHtml += `
                        <div class="user-item">
                            <strong>${user.name}</strong><br>
                            <span class="role-badge ${roleClass}">${user.role}</span><br>
                            <small>${user.username}</small>
                        </div>
                    `;
                });
                userListHtml += '</div>';
                result.innerHTML += userListHtml;

                // éªŒè¯ä¸“å®¶è§’è‰²å‘½å
                const expertRoles = mockApi.users.filter(u => u.role.startsWith('expert')).map(u => u.role);
                const expectedExpertRoles = ['expert1', 'expert2', 'expert3', 'expert4', 'expert5', 'expert6', 'expert7'];
                
                const rolesMatch = JSON.stringify(expertRoles.sort()) === JSON.stringify(expectedExpertRoles);
                if (rolesMatch) {
                    result.innerHTML += '<div class="test-result success">âœ… ä¸“å®¶è§’è‰²å‘½åæ­£ç¡®</div>';
                } else {
                    result.innerHTML += '<div class="test-result error">âŒ ä¸“å®¶è§’è‰²å‘½åé”™è¯¯</div>';
                }

            } catch (error) {
                result.innerHTML += '<div class="test-result error">âŒ æµ‹è¯•å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // æµ‹è¯•è§’è‰²æ˜ å°„
        function testRoleMapping() {
            const result = document.getElementById('roleMappingResult');
            result.innerHTML = '';

            try {
                const testRoles = ['admin', 'expert1', 'expert2', 'expert3', 'expert4', 'expert5', 'expert6', 'expert7'];
                const expectedMappings = {
                    'admin': 'ç®¡ç†å‘˜',
                    'expert1': 'è¯„å®¡ä¸“å®¶1',
                    'expert2': 'è¯„å®¡ä¸“å®¶2',
                    'expert3': 'è¯„å®¡ä¸“å®¶3',
                    'expert4': 'è¯„å®¡ä¸“å®¶4',
                    'expert5': 'è¯„å®¡ä¸“å®¶5',
                    'expert6': 'è¯„å®¡ä¸“å®¶6',
                    'expert7': 'è¯„å®¡ä¸“å®¶7'
                };

                let allCorrect = true;
                testRoles.forEach(role => {
                    const mappedText = getRoleText(role);
                    const expectedText = expectedMappings[role];
                    
                    if (mappedText === expectedText) {
                        result.innerHTML += '<div class="test-result success">âœ… ' + role + ' â†’ ' + mappedText + '</div>';
                    } else {
                        result.innerHTML += '<div class="test-result error">âŒ ' + role + ' â†’ ' + mappedText + ' (æœŸæœ›: ' + expectedText + ')</div>';
                        allCorrect = false;
                    }
                });

                if (allCorrect) {
                    result.innerHTML += '<div class="test-result success">ğŸ‰ æ‰€æœ‰è§’è‰²æ˜ å°„æ­£ç¡®</div>';
                }

            } catch (error) {
                result.innerHTML += '<div class="test-result error">âŒ æµ‹è¯•å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // æµ‹è¯•ç™»å½•è·³è½¬
        function testLoginRedirect() {
            const result = document.getElementById('loginRedirectResult');
            result.innerHTML = '';

            try {
                // æ¨¡æ‹Ÿç™»å½•è·³è½¬é€»è¾‘
                function testRedirectByRole(role) {
                    if (role === 'admin') {
                        return 'admin/dashboard.html';
                    } else if (role.startsWith('expert')) {
                        return 'expert/scoring.html';
                    }
                    return 'unknown';
                }

                const testCases = [
                    { role: 'admin', expected: 'admin/dashboard.html' },
                    { role: 'expert1', expected: 'expert/scoring.html' },
                    { role: 'expert2', expected: 'expert/scoring.html' },
                    { role: 'expert3', expected: 'expert/scoring.html' },
                    { role: 'expert4', expected: 'expert/scoring.html' },
                    { role: 'expert5', expected: 'expert/scoring.html' },
                    { role: 'expert6', expected: 'expert/scoring.html' },
                    { role: 'expert7', expected: 'expert/scoring.html' }
                ];

                let allCorrect = true;
                testCases.forEach(testCase => {
                    const actual = testRedirectByRole(testCase.role);
                    if (actual === testCase.expected) {
                        result.innerHTML += '<div class="test-result success">âœ… ' + testCase.role + ' â†’ ' + actual + '</div>';
                    } else {
                        result.innerHTML += '<div class="test-result error">âŒ ' + testCase.role + ' â†’ ' + actual + ' (æœŸæœ›: ' + testCase.expected + ')</div>';
                        allCorrect = false;
                    }
                });

                if (allCorrect) {
                    result.innerHTML += '<div class="test-result success">ğŸ‰ æ‰€æœ‰ç™»å½•è·³è½¬æ­£ç¡®</div>';
                }

            } catch (error) {
                result.innerHTML += '<div class="test-result error">âŒ æµ‹è¯•å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // æµ‹è¯•æƒé™éªŒè¯
        function testPermissionCheck() {
            const result = document.getElementById('permissionResult');
            result.innerHTML = '';

            try {
                // æµ‹è¯•ä¸“å®¶è§’è‰²è¿‡æ»¤
                const allUsers = mockApi.users;
                const expertUsers = allUsers.filter(u => u.role.startsWith('expert'));
                const adminUsers = allUsers.filter(u => u.role === 'admin');

                result.innerHTML += '<div class="test-result info">ğŸ“Š ç”¨æˆ·åˆ†ç±»ç»Ÿè®¡:</div>';
                result.innerHTML += '<div class="test-result success">âœ… ä¸“å®¶ç”¨æˆ·: ' + expertUsers.length + ' ä¸ª</div>';
                result.innerHTML += '<div class="test-result success">âœ… ç®¡ç†å‘˜ç”¨æˆ·: ' + adminUsers.length + ' ä¸ª</div>';

                // éªŒè¯ä¸“å®¶è§’è‰²åˆ—è¡¨
                const expertRoles = ['expert1', 'expert2', 'expert3', 'expert4', 'expert5', 'expert6', 'expert7'];
                const foundExpertRoles = expertUsers.map(u => u.role).sort();
                
                if (JSON.stringify(foundExpertRoles) === JSON.stringify(expertRoles)) {
                    result.innerHTML += '<div class="test-result success">âœ… ä¸“å®¶è§’è‰²è¿‡æ»¤æ­£ç¡®</div>';
                } else {
                    result.innerHTML += '<div class="test-result error">âŒ ä¸“å®¶è§’è‰²è¿‡æ»¤é”™è¯¯</div>';
                }

                // æµ‹è¯•è§’è‰²æƒé™åˆ¤æ–­
                const permissionTests = [
                    { role: 'admin', isAdmin: true, isExpert: false },
                    { role: 'expert1', isAdmin: false, isExpert: true },
                    { role: 'expert7', isAdmin: false, isExpert: true }
                ];

                permissionTests.forEach(test => {
                    const isAdmin = test.role === 'admin';
                    const isExpert = test.role.startsWith('expert');
                    
                    if (isAdmin === test.isAdmin && isExpert === test.isExpert) {
                        result.innerHTML += '<div class="test-result success">âœ… ' + test.role + ' æƒé™åˆ¤æ–­æ­£ç¡®</div>';
                    } else {
                        result.innerHTML += '<div class="test-result error">âŒ ' + test.role + ' æƒé™åˆ¤æ–­é”™è¯¯</div>';
                    }
                });

            } catch (error) {
                result.innerHTML += '<div class="test-result error">âŒ æµ‹è¯•å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // æµ‹è¯•é¡¹ç›®è§’è‰²é…ç½®
        function testProjectRoles() {
            const result = document.getElementById('projectRolesResult');
            result.innerHTML = '';

            try {
                // æµ‹è¯•ä¸“å®¶è§’è‰²è·å–
                mockApi.getExpertRoles().then(response => {
                    if (response.success) {
                        const expertRoles = response.data;
                        result.innerHTML += '<div class="test-result success">âœ… è·å–ä¸“å®¶è§’è‰²æˆåŠŸ: ' + expertRoles.length + ' ä¸ªè§’è‰²</div>';
                        
                        // éªŒè¯è§’è‰²åˆ—è¡¨
                        const expectedRoles = ['expert1', 'expert2', 'expert3', 'expert4', 'expert5', 'expert6', 'expert7'];
                        if (JSON.stringify(expertRoles.sort()) === JSON.stringify(expectedRoles)) {
                            result.innerHTML += '<div class="test-result success">âœ… ä¸“å®¶è§’è‰²åˆ—è¡¨æ­£ç¡®</div>';
                        } else {
                            result.innerHTML += '<div class="test-result error">âŒ ä¸“å®¶è§’è‰²åˆ—è¡¨é”™è¯¯</div>';
                        }
                    } else {
                        result.innerHTML += '<div class="test-result error">âŒ è·å–ä¸“å®¶è§’è‰²å¤±è´¥</div>';
                    }
                }).catch(error => {
                    result.innerHTML += '<div class="test-result error">âŒ è·å–ä¸“å®¶è§’è‰²å¼‚å¸¸: ' + error.message + '</div>';
                });

                // æµ‹è¯•é¡¹ç›®æ¨¡æ¿ä¸­çš„è§’è‰²é…ç½®
                const templates = mockApi.projectTemplates;
                if (templates && templates.length > 0) {
                    result.innerHTML += '<div class="test-result success">âœ… é¡¹ç›®æ¨¡æ¿é…ç½®æ­£ç¡®</div>';
                    
                    // æ£€æŸ¥æ¨¡æ¿ä¸­çš„è§’è‰²é…ç½®
                    templates.forEach(template => {
                        if (template.scoreItems) {
                            template.scoreItems.forEach(item => {
                                if (item.roles && item.roles.length > 0) {
                                    result.innerHTML += '<div class="test-result info">ğŸ“‹ ' + template.name + ' - ' + item.name + ': ' + item.roles.join(', ') + '</div>';
                                }
                            });
                        }
                    });
                } else {
                    result.innerHTML += '<div class="test-result error">âŒ é¡¹ç›®æ¨¡æ¿é…ç½®é”™è¯¯</div>';
                }

            } catch (error) {
                result.innerHTML += '<div class="test-result error">âŒ æµ‹è¯•å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // æµ‹è¯•ç»Ÿè®¡åŠŸèƒ½
        function testStatistics() {
            const result = document.getElementById('statisticsResult');
            result.innerHTML = '';

            try {
                // æµ‹è¯•é¡¹ç›®ç»Ÿè®¡
                mockApi.getProjectStats().then(response => {
                    if (response.success) {
                        const stats = response.data;
                        result.innerHTML += '<div class="test-result success">âœ… é¡¹ç›®ç»Ÿè®¡è·å–æˆåŠŸ</div>';
                        result.innerHTML += '<div class="test-result info">ğŸ“Š æ€»ä¸“å®¶æ•°: ' + stats.totalExperts + '</div>';
                        
                        if (stats.totalExperts === 7) {
                            result.innerHTML += '<div class="test-result success">âœ… ä¸“å®¶ç»Ÿè®¡æ­£ç¡®</div>';
                        } else {
                            result.innerHTML += '<div class="test-result error">âŒ ä¸“å®¶ç»Ÿè®¡é”™è¯¯: æœŸæœ›7ï¼Œå®é™…' + stats.totalExperts + '</div>';
                        }
                    } else {
                        result.innerHTML += '<div class="test-result error">âŒ é¡¹ç›®ç»Ÿè®¡è·å–å¤±è´¥</div>';
                    }
                }).catch(error => {
                    result.innerHTML += '<div class="test-result error">âŒ é¡¹ç›®ç»Ÿè®¡å¼‚å¸¸: ' + error.message + '</div>';
                });

            } catch (error) {
                result.innerHTML += '<div class="test-result error">âŒ æµ‹è¯•å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        function runAllTests() {
            const result = document.getElementById('allTestsResult');
            result.innerHTML = '<div class="test-result info">ğŸ”„ æ­£åœ¨è¿è¡Œæ‰€æœ‰æµ‹è¯•...</div>';

            // ä¾æ¬¡è¿è¡Œæ‰€æœ‰æµ‹è¯•
            setTimeout(() => testUserData(), 100);
            setTimeout(() => testRoleMapping(), 200);
            setTimeout(() => testLoginRedirect(), 300);
            setTimeout(() => testPermissionCheck(), 400);
            setTimeout(() => testProjectRoles(), 500);
            setTimeout(() => testStatistics(), 600);
            
            setTimeout(() => {
                result.innerHTML = '<div class="test-result success">ğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼è¯·æŸ¥çœ‹ä¸Šæ–¹å„æµ‹è¯•ç»“æœã€‚</div>';
            }, 1000);
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
        $(document).ready(function() {
            console.log('è§’è‰²æ‰©å±•æµ‹è¯•é¡µé¢å·²åŠ è½½');
            console.log('å½“å‰ç”¨æˆ·æ•°æ®:', mockApi.users);
        });
    </script>
</body>
</html> 