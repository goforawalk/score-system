# 评分系统项目架构分析报告（新版）

## 一、项目整体架构

本项目为**前后端分离**的专家评审系统，采用现代Web架构设计：
- **前端**：jQuery + Bootstrap + ECharts，静态资源部署于Web服务器
- **后端**：Spring Boot + MyBatis Plus，RESTful API，数据库支持SQL Server/H2
- **数据库**：SQL Server为主，支持H2内存数据库测试
- **通信协议**：前后端通过HTTP(S)接口（JSON）交互，支持跨域CORS

### 目录结构（核心部分）
```
score-system/
├── js/           # 前端JS代码（api、admin、expert、utils等）
├── admin/        # 管理员端页面
├── expert/       # 专家端页面
├── css/          # 样式文件
├── doc/Backend/  # 后端文档、SQL、测试
├── tests/        # 前端测试
└── ...
```

---

## 二、前端架构与功能

### 1. 技术栈与结构
- **jQuery**：DOM操作与事件处理
- **Bootstrap**：UI布局与响应式设计
- **ECharts**：统计图表
- **XLSX.js**：Excel导出功能
- **jsPDF + html2canvas**：PDF报告生成
- **模块划分**：
  - `js/api/`：API适配与服务层（api-adapter.js、api-service.js、config.js、http.js、mock.js、env.js）
  - `js/admin/`：管理员端业务逻辑（dashboard、project-management、user-management、scoring-management、statistics、task-management）
  - `js/expert/`：专家端业务逻辑（scoring、review-complete）
  - `js/utils/`：通用工具（auth.js、error-handler.js）
  - `js/lib/`：第三方库（echarts.min.js、xlsx.full.min.js、jspdf.umd.min.js、html2canvas.min.js）

### 2. 前端页面
- `admin/`：管理员仪表盘、项目管理、用户管理、评分管理、统计分析等页面
- `expert/`：专家评分、评审完成页面
- `index.html`：登录入口
- `cache-cleaner.html`：缓存清理工具页面

### 3. 前端API调用与分离机制
- **API适配层**：`js/api/api-adapter.js`根据环境切换mock/真实API，支持动态切换
- **API服务层**：`js/api/api-service.js`封装所有后端REST接口调用，所有页面通过此层与后端交互
- **HTTP工具**：`js/api/http.js`统一处理请求、响应、token、错误
- **环境配置**：`js/api/env.js`支持开发/生产环境切换，默认使用mock API避免后端连接问题
- **Mock数据**：`js/api/mock.js`提供完整的模拟数据，支持所有功能测试
- **会话管理**：`js/utils/auth.js`本地存储用户信息，支持角色判断、统一登出

### 4. 前端代码详细分析

#### 4.1 核心API层 (`js/api/`)

**`config.js` - API配置管理**
- **作用**: 集中管理所有API端点的配置
- **主要功能**:
  - 定义API基础URL和各个模块的端点路径
  - 提供动态URL生成函数（如根据ID生成特定资源URL）
  - 支持认证、用户管理、项目管理、任务管理、评分、统计等模块的API配置

**`api-service.js` - API服务层**
- **作用**: 封装所有与后端API的交互逻辑
- **主要方法**:
  - **认证相关**: `login()`, `logout()`
  - **用户管理**: `getUsers()`, `addUser()`, `updateUser()`, `deleteUser()`
  - **项目管理**: `getProjects()`, `createProject()`, `updateProject()`, `deleteProject()`
  - **任务管理**: `getTasks()`, `createTask()`, `enableTask()`, `completeTask()`
  - **评分管理**: `submitScore()`, `getScoreHistory()`, `getScoresByProject()`
  - **统计分析**: `getStatistics()`, `getProjectStatistics()`

**`http.js` - HTTP请求封装**
- **作用**: 封装HTTP请求的通用逻辑
- **主要功能**:
  - 统一的请求/响应拦截器
  - 错误处理和重试机制
  - 请求头管理和认证token处理
  - 支持GET、POST、PUT、DELETE等HTTP方法

**`mock.js` - 模拟数据服务**
- **作用**: 提供模拟API数据，用于前端开发和测试
- **主要功能**:
  - 模拟用户登录和权限验证
  - 提供项目、任务、评分等测试数据
  - 支持CRUD操作的模拟响应

**`env.js` - 环境配置**
- **作用**: 管理不同环境的配置参数
- **主要功能**:
  - 开发/测试/生产环境的API地址配置
  - 环境变量管理

**`api-adapter.js` - API适配器**
- **作用**: 统一API调用接口，支持真实API和模拟API的切换
- **主要功能**:
  - 提供统一的API调用方法
  - 支持开发模式下的模拟数据切换

#### 4.2 管理端模块 (`js/admin/`)

**`project-management.js` - 项目管理**
- **作用**: 管理项目全生命周期，包括评分项配置、专家分配、批量操作、模板管理等。
- **主要功能**: 项目列表加载与渲染、项目编辑/新建、评分项动态配置、项目模板应用、批量归档/删除、项目顺序调整、高级搜索与分页。
- **定义的方法函数**:
  - `loadProjects()`：调用API获取项目列表，渲染到页面。
  - `renderProjects(projects)`：渲染项目表格，支持分页与筛选。
  - `openDialog(title, project, existingRoles)`：弹出项目编辑/新建对话框，初始化评分项与专家角色。
  - `addScoreItemRow(group, name, roles, minScore, maxScore, availableRoles)`：添加评分项行，支持分组与角色分配。
  - `initializeScoreItemButtons()`：初始化评分项编辑、删除按钮事件。
  - `initTaskManagement()`：初始化任务管理相关功能。
  - `openTaskDialog(task, readOnly)`：弹出任务编辑/详情对话框，支持只读模式。
  - `handleTaskSubmit(e)`：处理任务表单提交，收集数据并调用API创建/更新任务。
  - `initBatchOperations()`：初始化批量归档、删除等操作按钮事件。
  - `handleBatchArchive()`/`handleBatchDelete()`：批量归档/删除项目，调用API并刷新列表。
  - `initializeAdvancedSearch()`：初始化高级搜索功能，绑定筛选事件。
- **触发的事件及业务逻辑**:
  - 项目编辑/新建按钮点击：弹出编辑对话框，加载项目数据。
  - 项目批量操作按钮点击：批量归档/删除选中项目，刷新页面。
  - 评分项添加/编辑/删除按钮点击：动态增删评分项，更新项目评分项配置。
  - 任务新建/编辑按钮点击：弹出任务编辑对话框，分配专家与项目顺序。
  - 搜索框输入、筛选条件变更：实时筛选项目列表，支持分页。
- **实现的业务逻辑**:
  - 项目和评分项的增删改查，评分项与专家角色的关联，项目模板的保存与应用，项目批量归档、删除，高级搜索与分页，任务与项目、专家的绑定。

**`user-management.js` - 用户管理**
- **作用**: 用户信息维护、角色分配、状态管理。
- **主要功能**: 用户列表加载与渲染、用户增删改、密码重置、角色分配。
- **定义的方法函数**:
  - `loadUsers()`：调用API获取用户列表，渲染到页面。
  - `addUser()`/`editUser(user)`/`deleteUser(username)`：用户增删改，调用API并刷新列表。
  - `resetPassword(username)`：重置用户密码，调用API。
- **触发的事件及业务逻辑**:
  - 用户编辑/新建/删除按钮点击：弹出编辑对话框，提交表单后刷新列表。
  - 用户状态切换：切换启用/禁用状态，调用API。
- **实现的业务逻辑**:
  - 用户信息维护，角色分配与权限管理，密码重置。

**`scoring-management.js` - 评分管理**
- **作用**: 评分进度监控、专家评分状态、评分结果统计。
- **主要功能**: 项目评分数据加载与展示、评分统计、评分详情查看、评分分布图表、评分导出。
- **定义的方法函数**:
  - `loadProjects()`：加载项目列表。
  - `loadProjectScores(projectId)`：加载项目评分统计与详情。
  - `renderScoreStats(data)`/`renderScoreDetails(details, scoreItems)`：渲染评分统计与详情。
  - `initScoreDistributionChart(data)`：初始化评分分布图表。
- **触发的事件及业务逻辑**:
  - 项目评分详情按钮点击：弹出评分详情对话框，展示评分分布。
  - 评分统计导出按钮点击：导出评分统计数据为Excel/PDF。
- **实现的业务逻辑**:
  - 评分进度与分布统计，专家评分完成情况展示，评分详情查看与导出。

**`scoring-progress.js` - 评分进度追踪**
- **作用**: 评分进度实时监控、切换模式、进度可视化。
- **主要功能**: 评分进度加载与展示、切换模式说明、评分明细弹窗、进度导出。
- **定义的方法函数**:
  - `loadProgress(taskId, isAuto)`：加载评分进度，支持自动/手动切换。
  - `showSwitchModeInfo(task, projectList)`：显示任务切换模式说明。
  - `showScoreDetailModal(projectId, taskId, projectName)`：弹出评分明细对话框。
  - `updateExportBtnVisibility(isCompleted)`/`exportTaskExcel(taskId)`：导出评分进度数据。
- **触发的事件及业务逻辑**:
  - 进度刷新、切换模式按钮点击：重新加载进度，切换任务模式。
  - 导出按钮点击：导出当前评分进度。
- **实现的业务逻辑**:
  - 评分进度轮询与展示，任务切换模式说明，评分明细查看与导出。

**`statistics.js` - 统计分析**
- **作用**: 多维度统计分析、报表生成与导出。
- **主要功能**: 统计数据加载与展示、图表渲染、数据筛选、报表导出。
- **定义的方法函数**:
  - `loadStatisticsByTask(taskId)`：加载任务统计数据。
  - `statisticsCache.set/get()`：统计数据缓存管理。
  - `initializeCharts(statistics)`/`updateCharts(projectId, taskId)`：图表初始化与更新。
  - `handleExportExcel()`/`handleExportPDF()`：数据导出。
  - `generateExcelFile(data)`/`generatePDFReport(data)`：生成Excel/PDF文件。
- **触发的事件及业务逻辑**:
  - 统计导出按钮点击：导出统计数据。
  - 任务/项目切换：切换统计维度，刷新图表与数据。
- **实现的业务逻辑**:
  - 统计数据聚合与可视化，报表导出，数据筛选与缓存。

**`dashboard.js` - 管理仪表板**
- **作用**: 系统概览、快速操作入口、实时监控。
- **主要功能**: 仪表盘数据加载与展示、图表渲染、快捷操作。
- **定义的方法函数**:
  - `loadDashboardData()`：加载仪表盘数据。
  - `renderDashboardCharts(data)`：渲染仪表盘图表。
- **触发的事件及业务逻辑**:
  - 仪表盘刷新、快捷操作按钮点击：刷新数据或跳转到相关页面。
- **实现的业务逻辑**:
  - 系统核心数据汇总展示，快捷操作入口。

**`task-management.js` - 任务管理**
- **作用**: 评审任务创建、配置、状态管理。
- **主要功能**: 任务增删改、专家分配、项目顺序设置、任务启用/完成。
- **定义的方法函数**:
  - `createTask()`/`editTask(task)`/`deleteTask(taskId)`：任务增删改。
  - `assignExperts(taskId, experts)`：分配专家。
  - `setProjectOrder(taskId, projectIds)`：设置项目顺序。
  - `enableTask(taskId)`/`completeTask(taskId)`：任务启用/完成。
- **触发的事件及业务逻辑**:
  - 任务新建/编辑/删除按钮点击：弹出任务编辑对话框，提交后刷新列表。
  - 专家分配、项目排序操作：拖拽排序、分配专家，保存后更新任务配置。
- **实现的业务逻辑**:
  - 任务与专家、项目的关联，任务状态流转，项目顺序调整。

#### 4.3 专家端模块 (`js/expert/`)

**`scoring.js` - 专家评分界面**
- **作用**: 专家评分主流程，动态加载评分项、评分提交、草稿保存、项目切换、进度监控。
- **主要功能**: 活动任务与项目加载、评分项加载、评分提交与校验、草稿自动保存与恢复、项目切换、评分历史查询、项目导航渲染、任务完成流程。
- **定义的方法函数**:
  - `loadActiveTask()`：获取当前专家的活动任务与项目。
  - `loadProjectScoreItems(projectId, taskId)`：加载当前项目评分项。
  - `submitScore(scoreData)`：提交评分，校验数据后调用API。
  - `saveDraft(scoreData)`：本地保存评分草稿。
  - `switchProject(nextProjectId)`：切换到下一个项目，自动/手动流转。
  - `loadScoringHistory(projectId, username, taskId)`：加载评分历史。
  - `renderProjectNavigation(projects)`：渲染项目导航，支持快速切换。
  - `initAutoSave()`/`saveScoreDraft()`/`loadScoreDraft()`：自动保存与草稿恢复。
  - `showTaskCompletionDialog()`/`completeReviewTask()`：任务完成流程，弹窗提示与API调用。
- **触发的事件及业务逻辑**:
  - 评分提交按钮点击：校验评分项，提交评分，保存草稿。
  - 项目切换按钮点击：切换项目，保存当前评分数据。
  - 自动保存定时器：定时保存评分草稿，防止数据丢失。
  - 评分草稿保存/恢复：本地缓存评分数据，断点续评。
- **实现的业务逻辑**:
  - 评分项动态加载，评分数据校验与提交，草稿自动保存与恢复，项目导航与切换，任务完成状态处理，评分历史查询。

**`review-complete.js` - 评审完成页面**
- **作用**: 专家任务完成后的总结与展示，评分记录回显。
- **主要功能**: 任务完成状态展示、评分结果回显、统计信息展示、本地缓存清理。
- **定义的方法函数**:
  - `renderSummary(task, projects, myScores)`：渲染专家本次任务下所有项目的评分情况。
  - `showNoTask(message)`：无任务提示。
  - `logoutBtn`事件：清空本地缓存、登出。
- **触发的事件及业务逻辑**:
  - 页面加载：加载任务与评分结果，展示统计信息。
  - 退出/清理按钮点击：清空本地缓存，登出系统。
- **实现的业务逻辑**:
  - 评分结果回显，统计信息展示，本地缓存清理，无任务提示。

---

## 三、后端架构与功能

### 2. 后端代码详细分析

#### 2.1 服务层 (`service/`)

- **ProjectServiceImpl.java**
  - **作用**: 项目相关业务逻辑实现，包括项目CRUD、评分项管理、批量操作、顺序调整、进度与评分统计。
  - **主要功能**: 项目增删改查、评分项配置、批量更新/删除、项目顺序调整、项目进度与评分详情查询。
  - **定义的方法函数**:
    - `getProjects()`：获取项目列表。
    - `getProjectById(id)`：获取项目详情。
    - `saveProject(project)`：创建/更新项目。
    - `deleteProject(id)`：删除项目。
    - `batchUpdateStatus(projectIds, status)`：批量更新项目状态。
    - `batchDelete(projectIds)`：批量删除项目。
    - `updateOrder(projectIds)`：更新项目顺序。
    - `getProjectProgress(projectId, taskId)`：获取项目评分进度。
    - `getProjectScores(projectId, taskId)`：获取项目评分详情。
  - **触发的事件及业务逻辑**:
    - Controller层REST接口调用，参数校验、数据转换、数据库操作、事务处理、统计聚合、权限校验、异常处理。
  - **实现的业务逻辑**:
    - 项目和评分项的增删改查，批量操作，项目顺序调整，进度与评分统计，支持taskId参数。

- **TaskServiceImpl.java**
  - **作用**: 任务相关业务逻辑实现，包括任务CRUD、专家分配、项目顺序设置、任务状态流转、进度与评分统计。
  - **主要功能**: 任务增删改查、专家分配、项目顺序设置、任务启用/完成、进度与评分统计。
  - **定义的方法函数**:
    - `getAllTasks()`：获取任务列表。
    - `getTaskById(id)`：获取任务详情。
    - `saveTask(task)`：创建/更新任务。
    - `enableTask(taskId)`/`completeTask(taskId)`：任务启用/完成。
    - `getTaskProjectProgressAndScores(taskId)`：获取任务下项目进度与总分。
  - **触发的事件及业务逻辑**:
    - Controller层REST接口调用，参数校验、数据转换、数据库操作、事务处理、统计聚合、权限校验、异常处理。
  - **实现的业务逻辑**:
    - 任务与专家、项目的关联，任务状态流转，项目顺序调整，进度与评分统计。

- **ScoreServiceImpl.java**
  - **作用**: 评分相关业务逻辑实现，包括评分提交、查询、统计，支持按任务、项目、用户多维度查询。
  - **主要功能**: 评分提交与校验、评分历史查询、评分统计、评分详情获取。
  - **定义的方法函数**:
    - `submitScore(scoreData)`：提交评分。
    - `getScoresByTask(taskId)`：按任务获取评分。
    - `getScoresByProject(projectId, taskId)`：按项目获取评分。
    - `getScoresByUser(username, taskId)`：按用户获取评分。
    - `getAllScores(taskId)`：获取所有评分记录。
    - `getProjectScoreStatistics(projectId, taskId)`：评分统计。
  - **触发的事件及业务逻辑**:
    - Controller层REST接口调用，参数校验、数据转换、数据库操作、事务处理、统计聚合、权限校验、异常处理。
  - **实现的业务逻辑**:
    - 评分提交与校验，评分历史与统计，支持多维度查询。

- **StatisticsServiceImpl.java**
  - **作用**: 统计相关业务逻辑实现，包括仪表盘统计、项目/专家/评分项统计、数据导出。
  - **主要功能**: 统计数据聚合与可视化、报表导出、支持多场景统计。
  - **定义的方法函数**:
    - `getProjectStatistics(taskId)`：获取项目统计数据。
    - `getFrontendStatistics(taskId)`：获取前端统计数据。
    - `getDashboardStatistics()`：获取仪表盘统计数据。
    - `getScoreItemStatistics(taskId)`：评分项统计。
    - `getExpertStatistics(taskId)`：专家统计。
    - `exportStatistics(taskId, format, options)`：统计数据导出。
  - **触发的事件及业务逻辑**:
    - Controller层REST接口调用，参数校验、数据转换、数据库操作、事务处理、统计聚合、权限校验、异常处理。
  - **实现的业务逻辑**:
    - 统计数据聚合与可视化，报表导出，支持多场景统计。

---

### 新增与调整内容对比说明

- 对前端`js/admin`和`js/expert`下所有业务JS文件的作用、主要功能、方法函数、事件及业务逻辑进行了细化和补充，完善了原有章节内容。
- 对后端`service`层各实现类的作用、主要功能、方法函数、事件及业务逻辑进行了补充，确保与前端API服务层严格对应。
- 所有内容已按原有章节结构补充完善，确保架构分析报告覆盖最新代码结构和业务逻辑细节

## 四、评审进度页面（scoring-progress.html & scoring-progress.js）业务功能与事件逻辑分析

### 1. 页面核心业务功能

- **任务选择与进度展示**  
  管理员可选择当前评审任务，自动加载任务下所有项目的评分进度、已评分专家、总分等信息。进度条动态展示每个项目的评分完成率，未完成项目高亮显示（同步评审+手动切换模式）。

- **自动刷新与倒计时**  
  页面每30秒自动刷新当前任务进度，倒计时显示剩余刷新时间。切换任务时重置倒计时与自动刷新。

- **切换模式管理（自动/手动）**  
  支持同步评审任务切换“自动切换/手动切换”模式，管理员可一键切换。手动切换模式下，支持“下一项目”按钮，管理员可手动流转到下一个项目。

- **项目顺序调整**  
  手动切换模式且任务未开始评审时，管理员可点击“调整项目顺序”按钮，弹出拖拽排序窗口。仅未开始评审的项目可调整顺序，保存后立即生效并刷新进度。

- **评分明细弹窗**  
  每个项目支持“明细”按钮，弹出窗口展示该项目所有评分项、专家及分数明细。

- **EXCEL导出**  
  任务完成后，管理员可一键导出当前任务所有项目评分数据为Excel文件。

- **安全登出与缓存清理**  
  支持安全退出，可选清空本地评分缓存，避免数据残留影响后续评审。

---

### 2. 主要按钮与弹窗事件逻辑

- **任务选择下拉框（#taskSelect）**
  - 事件：change
  - 逻辑：停止旧定时器，加载所选任务的进度数据，启动自动刷新倒计时。

- **切换模式按钮（#switchModeBtn）**
  - 事件：click
  - 逻辑：判断当前模式，调用API切换自动/手动模式，刷新进度数据。

- **手动切换项目按钮（#manualSwitchBtn）**
  - 事件：click
  - 逻辑：查找当前未评审项目，调用API手动流转到下一个项目，刷新进度。

- **调整项目顺序按钮（#reorderBtn）**
  - 事件：click
  - 逻辑：停止自动刷新，弹出项目顺序调整窗口，加载未评审项目列表，支持拖拽排序。

- **项目顺序调整弹窗**
  - 保存顺序按钮（#saveReorderBtn）：收集拖拽后的项目ID顺序，调用API保存，关闭弹窗并刷新进度。
  - 取消按钮（#cancelReorderBtn）/关闭按钮（#closeReorderModal）：关闭弹窗，恢复自动刷新。

- **评分明细弹窗（#scoreDetailModal）**
  - 明细按钮（每行）：调用API获取项目评分明细，弹窗展示评分项、专家、分数。
  - 关闭按钮（#closeScoreDetail）：关闭评分明细弹窗。

- **EXCEL导出按钮（#exportBtn）**
  - 事件：click
  - 逻辑：仅任务完成时可见，调用API导出Excel，自动下载评分数据文件。

- **安全登出按钮（#logoutBtn）**
  - 事件：click
  - 逻辑：弹窗确认是否清空本地缓存，清理后安全登出并跳转登录页。

---

### 3. 前后端交互与实现说明

- 前端所有进度数据、评分明细、项目顺序调整、切换模式、手动流转、导出等均通过`api-service.js`统一调用后端REST接口。
- 后端`TaskServiceImpl`和`ScoreServiceImpl`负责任务、项目、评分、顺序、状态流转等业务逻辑，确保数据一致性和权限校验。
- 典型接口包括：`getTaskProjectProgressAndScores`（任务下项目进度与评分）、`manualSwitch`（手动流转项目）、`reorderTaskProjects`（项目顺序调整）、`getProjectScoreDetails`（评分明细）、`exportTaskExcel`（导出Excel）、`updateTaskSwitchMode`（切换模式）。
- 所有操作均有错误处理与提示，保证管理员操作安全、流程可控。

---

### 4. 典型业务流程举例

1. 管理员选择任务，自动展示所有项目进度，支持实时刷新。
2. 同步评审任务可切换自动/手动模式，手动模式下可手动流转项目和调整顺序。
3. 每个项目可查看评分明细，任务完成后可导出全部评分数据。
4. 所有操作均有权限校验和错误提示，支持安全登出与缓存清理。